{% extends 'main_page.html' %}

{% block title %}
    <title>Page with QR generation</title>
{% endblock %}

{% block user %}
{% endblock %}


{% block content %}
 <h2>Сотрудники компании </h2>
    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th>Сотрудник</th>
                <th>Отдел</th>
                <th>Должность</th>
                <th>e-mail</th>
                <th>Руководители</th>
                <th>Количество звонков
                    за последние 24 часа</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
                {% for department in employee.UF_DEPARTMENT %}
                    {% if department != 1 or employee.UF_DEPARTMENT|length <= 1 %}
                    <tr data-employee-id="{{ employee.ID }}" data-department-id="{{ department }}">
                        <td> <a href="javascript:void(0)" onclick="openEmployeeSlide({{ employee.ID }}, event)">{{ employee.LAST_NAME }} {{ employee.NAME }} {% if employee.SECOND_NAME %} {{ employee.SECOND_NAME }} {% endif %} </a> </td>
                        <td class="department"></td>
                        <td>{{ employee.WORK_POSITION }}</td>
                        <td>{{ employee.EMAIL }}</td>
                        <td class="head-response"></td>
                        <td class="callCount"></td>
                    </tr>
                    {% endif %}
                {% endfor %}
            {% empty %}
            <tr>
                <td colspan="4">Сотрудников не найдено</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <form id="callGenForm" class="call-gen-form">
        <div class="form-group">
            <label for="callCountInput">Количество звонков:</label>
            <input type="number" id="callCountInput" name="callCountInput" min="1" max="50" value="10" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary generate-btn m-3">
            <i class="fas fa-phone"></i> Сгенерировать звонки
        </button>

        <div id="generationResult" class="mt-3 alert">

        </div>
    </form>

<script src="https://unpkg.com/@bitrix24/b24jssdk@latest/dist/umd/index.min.js"></script>
<script src="https://api.bitrix24.com/api/v1/"></script>
<script>

        async function getAllDirectors(userId, deptId, $b24){
            let directors=[];
            let currDeptId = deptId;
            const maxDepth = 10;
            let depth = 0;
            while(currDeptId && depth++ < maxDepth){
                const deptResponse = await $b24.callMethod('department.get', {
                    "ID": currDeptId,
                    "SELECT": ['UF_HEAD', 'NAME','PARENT']
                });
                const deptData = deptResponse.getData().result[0];

                if (deptData?.UF_HEAD && deptData.UF_HEAD!=userId){
                    const directorResponse = await $b24.callMethod('user.get', {
                        ID: deptData.UF_HEAD,
                        SELECT: ['NAME', 'SECOND_NAME', 'LAST_NAME']
                    });
                    const directorData = directorResponse.getData().result[0];
                    directors.push(`${directorData.LAST_NAME} ${directorData.NAME} ${directorData.SECOND_NAME || ''}`.trim());
                }
                currDeptId = deptData.PARENT;

            }
            return directors.join(", ");
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('callGenForm');
            const resultDiv = document.getElementById('generationResult');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const callCount = parseInt(document.getElementById('callCountInput').value);

                if (callCount < 1 || callCount > 100) {
                    showResult('Введите число от 1 до 100', 'danger');
                    return;
                }

                try {
                    const response = await fetch('{% url "employees:generate_test_calls" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify({
                            count: callCount
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        resultDiv.textContent = `Успешно сгенерировано звонков: ${data.count_generated}`
                    }
                    else {
                        throw new Error(data.error || 'Ошибка сервера');
                    }
                } catch (error){
                    console.log("Ошибка генерации" + error)
                }
            });
        });

        function openEmployeeSlide(userId, event) {
            try{
                event.preventDefault();
                BX24.init(
                    function()
                    {
                        BX24.openPath(
                            `/company/personal/user/${userId}/`.trim(),
                            function(result)
                            {
                                console.log(result);
                            }
                        );
                    }
                );
            }
            catch(err)
            {
                console.error('Ошибка открытия слайдера:', err);
            }
        }
    let $b24;
    document.addEventListener('DOMContentLoaded', async () => {
        try
        {
            $b24 = await B24Js.initializeB24Frame();
            const logger = B24Js.LoggerBrowser.build('MyApp', true);
            $b24.setLogger(
                logger
            );
            logger.info('Bitrix24 SDK инициализирован');

            const rows = document.querySelectorAll('tr[data-employee-id]');

            for (const row of rows) {
                const employeeId = row.getAttribute('data-employee-id');
                const departmentId = row.getAttribute('data-department-id');
                if (!employeeId) continue;

                const deptResponse = await $b24.callMethod('department.get', {
                    "ID": departmentId,
                    "SELECT": ['NAME']
                });
                const deptData = deptResponse.getData().result[0];
                console.log(deptData);
                row.querySelector('.department').textContent = deptData['NAME'];

                const response = await $b24.callMethod(
                'voximplant.statistic.get',
                {
                    "FILTER": { "PORTAL_USER_ID": employeeId, ">CALL_DURATION":60}
                });

                const callCount = response.getData()?.total || 0;

                row.querySelector('.callCount').textContent = callCount;

                row.querySelector('.head-response').textContent = await getAllDirectors(employeeId, departmentId, $b24) || 'Нет';
                }
        }
        catch (error)
        {
            console.error(error);
        }
    });


</script>
{% endblock %}
