{% extends 'main_page.html' %}

{% block title %}
    <title>Page with contacts</title>
{% endblock %}

{% block user %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div style="height: 800px;" class="col-lg-6 col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form id="importFile" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0">Импорт контактов</h3>
                        </div>

                        <div class="mb-3">
                            <input type="file" class="form-control form-control-lg  mt-4"
                                   id="fileToImport" required>
                            <div class="invalid-feedback">Пожалуйста, выберите файл</div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg py-3" id="importButton">
                                <i class="bi bi-plus-circle me-2"></i>Импортировать
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form id="exportFile" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0">Экспорт контактов</h3>
                        </div>

                        <div class="date-filter row">
                            <div class="row justify-content-left">
                                <div class="col-md-4">
                                    <span>Дата создания с</span>
                                    <input type="date" id="dateFrom" name="dateFrom" class="form-control">
                                </div>
                            </div>
                            <div class="row justify-content-left">
                                <div class="col-md-4">
                                    <span>по</span>
                                    <input type="date" id="dateTo" name="dateTo" class="form-control" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="type_id" class="form-label fw-bold">Выберите тип файла</label>
                            <select class="form-select form-select-lg" id="type_id" name="type_id">
                                <option value="csv">CSV</option>
                                <option value="xlsx">Excel</option>
                            </select>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg py-3" id="exportButton">
                                Экспорт контактов
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>

    document.addEventListener('DOMContentLoaded', function() {
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');

      const today = new Date().toISOString().split('T')[0];
      dateFrom.max = today;
      dateTo.max = today;

      dateFrom.addEventListener('change', function() {
        if (dateFrom.value) {
          dateTo.min = dateFrom.value;
          dateTo.disabled = false;
          if (dateTo.value && dateTo.value < dateFrom.value) {
            dateTo.value = dateFrom.value;
          }

          if (dateTo.value && dateTo.value < dateFrom.value) {
            dateTo.value = '';
          }
        } else {
          dateTo.disabled = true;
          dateTo.value = '';
        }
      });

      dateTo.addEventListener('change', function() {
        if (dateTo.value && dateTo.value < dateFrom.value) {
         dateTo.value = dateFrom.value;
      }
      });
    });


    document.getElementById('importFile').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        try {

            const fileInput = document.getElementById('fileToImport');
            const allowedExtensions = ['.csv', '.xlsx'];
            const fileName = fileInput.files[0].name.toLowerCase();

            if (!allowedExtensions.some(ext => fileName.endsWith(ext))) {
                throw new Error('Допустимы только CSV и Excel файлы');
            }

            const formData = new FormData();
            formData.append('fileToImport', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            const response = await fetch('{% url "contacts:import_file" %}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                alertDiv.innerHTML = `
                    <strong>Успешно загружены данные!</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert onclick="this.parentElement.remove()"></button>
                `;
                document.body.appendChild(alertDiv);
            } else {
                throw new Error(result.error || 'Неизвестная ошибка');
            }
        } catch (error) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
            alertDiv.innerHTML = `
                <strong>Ошибка!</strong> ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="this.parentElement.remove()"</button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    });

    document.getElementById('exportFile').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        try {
            const formData = new FormData(form);

            if (formData.get('dateFrom') === '') formData.delete('dateFrom');
            if (formData.get('dateTo') === '') formData.delete('dateTo');

            const response = await fetch('{% url "contacts:export_file" %}', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const contentType = response.headers.get('content-type');
                const filename = response.headers.get('content-disposition')?.split('filename=')[1] || 'contacts.csv';

                if (contentType.includes('application/json')) {
                    const result = await response.json();
                    throw new Error(result.error || 'Неизвестная ошибка');
                } else {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Неизвестная ошибка');
            }
        } catch (error) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
            alertDiv.innerHTML = `
                <strong>Ошибка!</strong> ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="this.parentElement.remove()"</button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    });

</script>

{% endblock %}
